<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Workspace - AI Training Platform</title>
    <script>
        tailwind = window.tailwind || {};
    </script>
    <script>
        window.tailwind = window.tailwind || {};
        window.tailwind.config = {
            theme: {
                extend: {}
            }
        };
    </script>
    <script src="https://cdn.tailwindcss.com?plugins=line-clamp"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .backdrop-blur {
            backdrop-filter: blur(12px);
        }
    </style>
</head>
<body class="min-h-screen bg-slate-950 text-white">
    <header class="border-b border-slate-900/80 bg-slate-950/80 backdrop-blur sticky top-0 z-20">
        <div class="max-w-6xl mx-auto px-4 sm:px-6 py-4 flex items-center justify-between">
            <a href="/" class="text-lg font-semibold text-white hover:text-violet-300 transition-colors">AI Training Platform</a>
            <nav class="flex items-center gap-3 text-sm">
                <a href="/" class="text-slate-300 hover:text-white transition-colors">หน้าแรก</a>
                <a href="/dataset" class="text-slate-300 hover:text-white transition-colors">Dataset</a>
                <a href="/model" class="text-slate-300 hover:text-white transition-colors">Model</a>
                <a href="/deploy" class="text-slate-300 hover:text-white transition-colors">Deploy</a>
            </nav>
        </div>
    </header>
    <main class="py-8 sm:py-12">
        <div id="knowledge-platform-root" class="max-w-6xl mx-auto px-4 sm:px-6"></div>
    </main>

    <script src="/static/vendor/react.production.min.js"></script>
    <script src="/static/vendor/react-dom.production.min.js"></script>
    <script src="/static/vendor/babel.min.js"></script>
    <script type="text/babel" data-presets="env,react">
        const { useState, useEffect, useMemo } = React;

        const DEFAULT_TEMPLATES = {
            writer: [
                {
                    id: 'writer_character_profile',
                    name: 'Character Profile',
                    description: 'สรุปคุณลักษณะและเป้าหมายของตัวละครหลัก',
                    fields: ['name', 'role', 'motivation', 'conflict']
                },
                {
                    id: 'writer_plot_blueprint',
                    name: 'Plot Blueprint',
                    description: 'โครงเรื่องหลักพร้อมเหตุการณ์สำคัญ',
                    fields: ['act', 'setup', 'climax', 'resolution']
                },
                {
                    id: 'writer_scene_tracker',
                    name: 'Scene Tracker',
                    description: 'ติดตามฉากและตัวละครที่เกี่ยวข้อง',
                    fields: ['scene', 'location', 'characters', 'notes']
                },
            ],
            ai_researcher: [
                {
                    id: 'ai_research_experiment_log',
                    name: 'Experiment Log',
                    description: 'บันทึกการทดลองพร้อม hyperparameters และผลลัพธ์',
                    fields: ['objective', 'setup', 'metrics', 'insights']
                },
                {
                    id: 'ai_research_paper_digest',
                    name: 'Paper Digest',
                    description: 'สรุปงานวิจัยพร้อมประเด็นสำคัญ',
                    fields: ['title', 'authors', 'method', 'contribution']
                },
                {
                    id: 'ai_research_dataset_card',
                    name: 'Dataset Card',
                    description: 'รายละเอียด dataset เพื่อใช้ในการทดลอง',
                    fields: ['name', 'size', 'modality', 'ethics']
                },
            ],
            fullstack_dev: [
                {
                    id: 'fullstack_component_doc',
                    name: 'Component Doc',
                    description: 'รายละเอียด component พร้อมตัวอย่างการใช้งาน',
                    fields: ['name', 'props', 'states', 'usage']
                },
                {
                    id: 'fullstack_api_contract',
                    name: 'API Contract',
                    description: 'สัญญาการใช้งาน API พร้อมตัวอย่าง request/response',
                    fields: ['endpoint', 'method', 'payload', 'response']
                },
                {
                    id: 'fullstack_bug_report',
                    name: 'Bug Report',
                    description: 'รายงานบั๊กพร้อมขั้นตอนการเกิดและผลกระทบ',
                    fields: ['title', 'steps', 'expected', 'actual']
                },
            ],
            general: [
                {
                    id: 'general_text_note',
                    name: 'Text Note',
                    description: 'โน้ตข้อความทั่วไป',
                    fields: ['title', 'content']
                },
                {
                    id: 'general_web_clip',
                    name: 'Web Clip',
                    description: 'สรุปจากบทความหรือเว็บไซต์',
                    fields: ['url', 'summary', 'tags']
                },
                {
                    id: 'general_video_summary',
                    name: 'Video Summary',
                    description: 'สรุปจากวิดีโอหรือ YouTube',
                    fields: ['url', 'key_points', 'action_items']
                },
                {
                    id: 'general_link_hub',
                    name: 'Link Hub',
                    description: 'รวมลิงก์ที่เกี่ยวข้อง',
                    fields: ['title', 'links', 'notes']
                },
                {
                    id: 'general_task_tracker',
                    name: 'Task Tracker',
                    description: 'ติดตามงานและสถานะ',
                    fields: ['task', 'status', 'priority', 'due']
                },
                {
                    id: 'general_meeting_notes',
                    name: 'Meeting Notes',
                    description: 'บันทึกการประชุม',
                    fields: ['date', 'attendees', 'summary', 'actions']
                },
            ],
        };

        const PROFESSION_OPTIONS = [
            { id: 'writer', name: 'นักเขียน', description: 'สร้างโลกและตัวละครได้อย่างเป็นระบบ' },
            { id: 'ai_researcher', name: 'นักวิจัย AI', description: 'จัดการงานวิจัยและการทดลองด้วยเครื่องมือครบ' },
            { id: 'fullstack_dev', name: 'Fullstack Dev', description: 'วางสเปกและติดตามงานพัฒนาได้อย่างปลอดภัย' },
        ];

        const formatDateTime = (value) => {
            if (!value) return '-';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return value;
            return date.toLocaleString('th-TH', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
        };

        const parseTags = (raw) => {
            if (!raw) return [];
            return raw
                .split(',')
                .map(tag => tag.trim())
                .filter(Boolean)
                .slice(0, 10);
        };

        const TemplateCard = ({ template, scope }) => {
            return (
                <div
                    data-testid={`${scope}-template-card`}
                    className="p-4 rounded-xl bg-slate-900/60 border border-slate-800 hover:border-violet-500/60 transition-colors"
                >
                    <div className="flex items-start justify-between">
                        <div>
                            <div className="text-base font-semibold text-white">{template.name}</div>
                            <p className="text-sm text-slate-400 mt-1">{template.description}</p>
                        </div>
                    </div>
                    <div className="mt-4 text-xs text-slate-400">
                        <div className="font-semibold text-slate-300 mb-1">Fields</div>
                        <div className="flex flex-wrap gap-1">
                            {template.fields.map(field => (
                                <span key={field} className="px-2 py-1 bg-slate-800 rounded-full text-slate-300">{field}</span>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const StatusBanner = ({ status, onClose }) => {
            if (!status) return null;
            const styles = status.type === 'error'
                ? 'bg-rose-500/10 border border-rose-400/40 text-rose-200'
                : 'bg-emerald-500/10 border border-emerald-400/40 text-emerald-200';
            return (
                <div data-testid="status-banner" className={`px-4 py-3 rounded-xl flex items-center justify-between ${styles}`}>
                    <span className="text-sm font-medium">{status.message}</span>
                    <button onClick={onClose} className="text-xs uppercase tracking-wide">Close</button>
                </div>
            );
        };

        function KnowledgePlatform() {
            const [profession, setProfession] = useState('writer');
            const [templates, setTemplates] = useState(DEFAULT_TEMPLATES);
            const [items, setItems] = useState([]);
            const [loading, setLoading] = useState(true);
            const [status, setStatus] = useState(null);
            const [submitting, setSubmitting] = useState({ article: false, youtube: false, text: false });
            const [query, setQuery] = useState('');
            const [queryResults, setQueryResults] = useState([]);
            const [queryLoading, setQueryLoading] = useState(false);
            const [textLength, setTextLength] = useState(0);

            const initialTemplateId = templates[profession]?.[0]?.id || DEFAULT_TEMPLATES.writer[0].id;

            const [articleForm, setArticleForm] = useState({
                title: '',
                url: '',
                summary: '',
                templateId: initialTemplateId,
                tags: ''
            });
            const [youtubeForm, setYoutubeForm] = useState({
                title: '',
                url: '',
                summary: '',
                templateId: initialTemplateId,
                tags: ''
            });
            const [textForm, setTextForm] = useState({
                title: '',
                templateId: initialTemplateId,
                tags: '',
                text: ''
            });

            const templateOptions = useMemo(() => {
                return [
                    ...(templates[profession] || []),
                    ...(templates.general || [])
                ];
            }, [profession, templates]);

            useEffect(() => {
                async function loadConfig() {
                    try {
                        const response = await fetch('/api/knowledge/templates');
                        if (response.ok) {
                            const data = await response.json();
                            if (data?.templates) {
                                setTemplates(data.templates);
                            }
                        }
                    } catch (error) {
                        console.error('Failed to load template config', error);
                    }
                }
                loadConfig();
            }, []);

            useEffect(() => {
                async function loadItems() {
                    setLoading(true);
                    try {
                        const response = await fetch('/api/knowledge/items');
                        if (!response.ok) throw new Error('ไม่สามารถโหลดข้อมูลได้');
                        const data = await response.json();
                        setItems(Array.isArray(data.items) ? data.items : []);
                    } catch (error) {
                        console.error(error);
                        setStatus({ type: 'error', message: error.message || 'เกิดข้อผิดพลาดในการโหลดข้อมูล' });
                    } finally {
                        setLoading(false);
                    }
                }
                loadItems();
            }, []);

            useEffect(() => {
                const nextTemplateId = templates[profession]?.[0]?.id || templates.general?.[0]?.id;
                if (!nextTemplateId) {
                    return;
                }
                setArticleForm(prev => ({ ...prev, templateId: nextTemplateId }));
                setYoutubeForm(prev => ({ ...prev, templateId: nextTemplateId }));
                setTextForm(prev => ({ ...prev, templateId: nextTemplateId }));
            }, [profession, templates]);

            const updateStatus = (message, type = 'success') => {
                setStatus({ message, type });
                setTimeout(() => setStatus(null), 5000);
            };

            const handleArticleSubmit = async (event) => {
                event.preventDefault();
                if (submitting.article) return;
                setSubmitting(prev => ({ ...prev, article: true }));
                try {
                    const payload = {
                        title: articleForm.title.trim(),
                        url: articleForm.url.trim(),
                        summary: articleForm.summary.trim() || undefined,
                        profession,
                        template_id: articleForm.templateId,
                        tags: parseTags(articleForm.tags)
                    };
                    const response = await fetch('/api/knowledge/import/article', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error('นำเข้าบทความไม่สำเร็จ');
                    const data = await response.json();
                    if (data?.item) {
                        setItems(prev => [data.item, ...prev]);
                        updateStatus('Article imported successfully', 'success');
                        setArticleForm({ title: '', url: '', summary: '', templateId: payload.template_id, tags: '' });
                    }
                } catch (error) {
                    updateStatus(error.message || 'เกิดข้อผิดพลาดในการนำเข้าบทความ', 'error');
                } finally {
                    setSubmitting(prev => ({ ...prev, article: false }));
                }
            };

            const handleYoutubeSubmit = async (event) => {
                event.preventDefault();
                if (submitting.youtube) return;
                setSubmitting(prev => ({ ...prev, youtube: true }));
                try {
                    const payload = {
                        title: youtubeForm.title.trim(),
                        url: youtubeForm.url.trim(),
                        summary: youtubeForm.summary.trim() || undefined,
                        profession,
                        template_id: youtubeForm.templateId,
                        tags: parseTags(youtubeForm.tags)
                    };
                    const response = await fetch('/api/knowledge/import/youtube', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error('นำเข้า YouTube ไม่สำเร็จ');
                    const data = await response.json();
                    if (data?.item) {
                        setItems(prev => [data.item, ...prev]);
                        updateStatus('YouTube imported successfully', 'success');
                        setYoutubeForm({ title: '', url: '', summary: '', templateId: payload.template_id, tags: '' });
                    }
                } catch (error) {
                    updateStatus(error.message || 'เกิดข้อผิดพลาดในการนำเข้า YouTube', 'error');
                } finally {
                    setSubmitting(prev => ({ ...prev, youtube: false }));
                }
            };

            const handleTextSubmit = async (event) => {
                event.preventDefault();
                if (submitting.text) return;
                setSubmitting(prev => ({ ...prev, text: true }));
                try {
                    const payload = {
                        title: textForm.title.trim(),
                        text: textForm.text,
                        profession,
                        template_id: textForm.templateId,
                        tags: parseTags(textForm.tags)
                    };
                    const response = await fetch('/api/knowledge/import/text', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error('นำเข้าข้อความไม่สำเร็จ');
                    const data = await response.json();
                    if (data?.item) {
                        setItems(prev => [data.item, ...prev]);
                        updateStatus('Text ingested successfully', 'success');
                        setTextForm({ title: '', templateId: payload.template_id, tags: '', text: '' });
                        setTextLength(0);
                    }
                } catch (error) {
                    updateStatus(error.message || 'เกิดข้อผิดพลาดในการนำเข้าข้อความ', 'error');
                } finally {
                    setSubmitting(prev => ({ ...prev, text: false }));
                }
            };

            const handleQuery = async (event) => {
                event.preventDefault();
                if (!query.trim()) return;
                setQueryLoading(true);
                try {
                    const response = await fetch('/api/knowledge/query', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: query.trim(), top_k: 5 })
                    });
                    if (!response.ok) throw new Error('ค้นหาไม่สำเร็จ');
                    const data = await response.json();
                    setQueryResults(Array.isArray(data.results) ? data.results : []);
                    updateStatus('Query completed', 'success');
                } catch (error) {
                    updateStatus(error.message || 'เกิดข้อผิดพลาดในการค้นหา', 'error');
                } finally {
                    setQueryLoading(false);
                }
            };

            const handleTextChange = (value) => {
                if (value.length > 200000) {
                    value = value.slice(0, 200000);
                }
                setTextForm(prev => ({ ...prev, text: value }));
                setTextLength(value.length);
            };

            return (
                <div data-testid="knowledge-app-loaded" className="space-y-8">
                    <div className="space-y-4">
                        <h1 className="text-3xl font-semibold">Knowledge Workspace</h1>
                        <p className="text-slate-300 text-sm">เครื่องมือสำหรับรวบรวมข้อมูลบทความ วิดีโอ และข้อความขนาดใหญ่ พร้อมค้นหาแบบ RAG</p>
                    </div>

                    <StatusBanner status={status} onClose={() => setStatus(null)} />

                    <section className="grid md:grid-cols-3 gap-4">
                        {PROFESSION_OPTIONS.map(option => (
                            <button
                                key={option.id}
                                type="button"
                                onClick={() => setProfession(option.id)}
                                className={`text-left p-5 rounded-2xl border transition-colors ${
                                    profession === option.id
                                        ? 'border-violet-500 bg-violet-500/10'
                                        : 'border-slate-800 bg-slate-900/40 hover:border-slate-700'
                                }`}
                            >
                                <div className="text-sm font-semibold text-white">{option.name}</div>
                                <p className="text-xs text-slate-400 mt-1">{option.description}</p>
                            </button>
                        ))}
                    </section>

                    <section className="bg-slate-900/60 border border-slate-800 rounded-2xl p-6 space-y-6">
                        <h2 className="text-xl font-semibold">Import data</h2>
                        <div className="grid md:grid-cols-3 gap-6">
                            <form onSubmit={handleArticleSubmit} className="space-y-4" aria-label="article-import-form">
                                <h3 className="text-lg font-medium">Article URL</h3>
                                <div>
                                    <label htmlFor="article-title" className="block text-xs text-slate-400 uppercase tracking-wide mb-1">Title</label>
                                    <input
                                        id="article-title"
                                        data-testid="article-title-input"
                                        type="text"
                                        required
                                        value={articleForm.title}
                                        onChange={(e) => setArticleForm(prev => ({ ...prev, title: e.target.value }))}
                                        className="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/40"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="article-url" className="block text-xs text-slate-400 uppercase tracking-wide mb-1">Article URL</label>
                                    <input
                                        id="article-url"
                                        data-testid="article-url-input"
                                        type="url"
                                        required
                                        value={articleForm.url}
                                        onChange={(e) => setArticleForm(prev => ({ ...prev, url: e.target.value }))}
                                        className="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/40"
                                        placeholder="https://"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="article-template" className="block text-xs text-slate-400 uppercase tracking-wide mb-1">Template</label>
                                    <select
                                        id="article-template"
                                        data-testid="article-template-select"
                                        required
                                        value={articleForm.templateId}
                                        onChange={(e) => setArticleForm(prev => ({ ...prev, templateId: e.target.value }))}
                                        className="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/40"
                                    >
                                        <optgroup label="Profession templates">
                                            {(templates[profession] || []).map(template => (
                                                <option key={template.id} value={template.id}>{template.name}</option>
                                            ))}
                                        </optgroup>
                                        <optgroup label="General templates">
                                            {(templates.general || []).map(template => (
                                                <option key={template.id} value={template.id}>{template.name}</option>
                                            ))}
                                        </optgroup>
                                    </select>
                                </div>
                                <div>
                                    <label htmlFor="article-tags" className="block text-xs text-slate-400 uppercase tracking-wide mb-1">Tags (comma separated)</label>
                                    <input
                                        id="article-tags"
                                        type="text"
                                        value={articleForm.tags}
                                        onChange={(e) => setArticleForm(prev => ({ ...prev, tags: e.target.value }))}
                                        className="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/40"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="article-summary" className="block text-xs text-slate-400 uppercase tracking-wide mb-1">Summary (optional)</label>
                                    <textarea
                                        id="article-summary"
                                        rows="3"
                                        value={articleForm.summary}
                                        onChange={(e) => setArticleForm(prev => ({ ...prev, summary: e.target.value }))}
                                        className="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/40"
                                    ></textarea>
                                </div>
                                <button
                                    type="submit"
                                    disabled={submitting.article}
                                    className="w-full py-2 rounded-lg bg-violet-600 hover:bg-violet-500 disabled:bg-slate-700 disabled:cursor-not-allowed font-semibold"
                                >
                                    {submitting.article ? 'Processing…' : 'Import Article'}
                                </button>
                            </form>

                            <form onSubmit={handleYoutubeSubmit} className="space-y-4" aria-label="youtube-import-form">
                                <h3 className="text-lg font-medium">YouTube URL</h3>
                                <div>
                                    <label htmlFor="youtube-title" className="block text-xs text-slate-400 uppercase tracking-wide mb-1">Title</label>
                                    <input
                                        id="youtube-title"
                                        data-testid="youtube-title-input"
                                        type="text"
                                        required
                                        value={youtubeForm.title}
                                        onChange={(e) => setYoutubeForm(prev => ({ ...prev, title: e.target.value }))}
                                        className="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/40"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="youtube-url" className="block text-xs text-slate-400 uppercase tracking-wide mb-1">YouTube URL</label>
                                    <input
                                        id="youtube-url"
                                        data-testid="youtube-url-input"
                                        type="url"
                                        required
                                        value={youtubeForm.url}
                                        onChange={(e) => setYoutubeForm(prev => ({ ...prev, url: e.target.value }))}
                                        className="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/40"
                                        placeholder="https://www.youtube.com/watch?v=..."
                                    />
                                </div>
                                <div>
                                    <label htmlFor="youtube-template" className="block text-xs text-slate-400 uppercase tracking-wide mb-1">Template</label>
                                    <select
                                        id="youtube-template"
                                        data-testid="youtube-template-select"
                                        required
                                        value={youtubeForm.templateId}
                                        onChange={(e) => setYoutubeForm(prev => ({ ...prev, templateId: e.target.value }))}
                                        className="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/40"
                                    >
                                        <optgroup label="Profession templates">
                                            {(templates[profession] || []).map(template => (
                                                <option key={template.id} value={template.id}>{template.name}</option>
                                            ))}
                                        </optgroup>
                                        <optgroup label="General templates">
                                            {(templates.general || []).map(template => (
                                                <option key={template.id} value={template.id}>{template.name}</option>
                                            ))}
                                        </optgroup>
                                    </select>
                                </div>
                                <div>
                                    <label htmlFor="youtube-tags" className="block text-xs text-slate-400 uppercase tracking-wide mb-1">Tags (comma separated)</label>
                                    <input
                                        id="youtube-tags"
                                        type="text"
                                        value={youtubeForm.tags}
                                        onChange={(e) => setYoutubeForm(prev => ({ ...prev, tags: e.target.value }))}
                                        className="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/40"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="youtube-summary" className="block text-xs text-slate-400 uppercase tracking-wide mb-1">Summary (optional)</label>
                                    <textarea
                                        id="youtube-summary"
                                        rows="3"
                                        value={youtubeForm.summary}
                                        onChange={(e) => setYoutubeForm(prev => ({ ...prev, summary: e.target.value }))}
                                        className="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/40"
                                    ></textarea>
                                </div>
                                <button
                                    type="submit"
                                    disabled={submitting.youtube}
                                    className="w-full py-2 rounded-lg bg-violet-600 hover:bg-violet-500 disabled:bg-slate-700 disabled:cursor-not-allowed font-semibold"
                                >
                                    {submitting.youtube ? 'Processing…' : 'Import YouTube'}
                                </button>
                            </form>

                            <form onSubmit={handleTextSubmit} className="space-y-4" aria-label="text-import-form">
                                <h3 className="text-lg font-medium">Raw Text</h3>
                                <div>
                                    <label htmlFor="text-title" className="block text-xs text-slate-400 uppercase tracking-wide mb-1">Title</label>
                                    <input
                                        id="text-title"
                                        data-testid="text-title-input"
                                        type="text"
                                        required
                                        value={textForm.title}
                                        onChange={(e) => setTextForm(prev => ({ ...prev, title: e.target.value }))}
                                        className="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/40"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="text-template" className="block text-xs text-slate-400 uppercase tracking-wide mb-1">Template</label>
                                    <select
                                        id="text-template"
                                        data-testid="text-template-select"
                                        required
                                        value={textForm.templateId}
                                        onChange={(e) => setTextForm(prev => ({ ...prev, templateId: e.target.value }))}
                                        className="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/40"
                                    >
                                        <optgroup label="Profession templates">
                                            {(templates[profession] || []).map(template => (
                                                <option key={template.id} value={template.id}>{template.name}</option>
                                            ))}
                                        </optgroup>
                                        <optgroup label="General templates">
                                            {(templates.general || []).map(template => (
                                                <option key={template.id} value={template.id}>{template.name}</option>
                                            ))}
                                        </optgroup>
                                    </select>
                                </div>
                                <div>
                                    <label htmlFor="text-tags" className="block text-xs text-slate-400 uppercase tracking-wide mb-1">Tags (comma separated)</label>
                                    <input
                                        id="text-tags"
                                        type="text"
                                        value={textForm.tags}
                                        onChange={(e) => setTextForm(prev => ({ ...prev, tags: e.target.value }))}
                                        className="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/40"
                                    />
                                </div>
                                <div>
                                    <label htmlFor="text-body" className="block text-xs text-slate-400 uppercase tracking-wide mb-1">Text body (สูงสุด 200,000 ตัวอักษร)</label>
                                    <textarea
                                        id="text-body"
                                        data-testid="text-body-input"
                                        rows="10"
                                        required
                                        maxLength="200000"
                                        value={textForm.text}
                                        onChange={(e) => handleTextChange(e.target.value)}
                                        className="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/40"
                                    ></textarea>
                                    <div className="text-xs text-slate-400 text-right">{textLength.toLocaleString()} / 200,000</div>
                                </div>
                                <button
                                    type="submit"
                                    disabled={submitting.text}
                                    className="w-full py-2 rounded-lg bg-violet-600 hover:bg-violet-500 disabled:bg-slate-700 disabled:cursor-not-allowed font-semibold"
                                >
                                    {submitting.text ? 'Processing…' : 'Ingest Text'}
                                </button>
                            </form>
                        </div>
                    </section>

                    <section className="space-y-4">
                        <div className="flex items-center justify-between">
                            <h2 className="text-xl font-semibold">Templates overview</h2>
                            <span className="text-sm text-slate-400">เลือกอาชีพเพื่อดูเทมเพลตเฉพาะด้าน</span>
                        </div>
                        <div className="grid md:grid-cols-3 gap-4">
                            {(templates[profession] || []).map(template => (
                                <TemplateCard key={template.id} template={template} scope={profession} />
                            ))}
                        </div>
                        <h3 className="text-lg font-semibold mt-6">General templates</h3>
                        <div className="grid md:grid-cols-3 gap-4">
                            {(templates.general || []).map(template => (
                                <TemplateCard key={template.id} template={template} scope="general" />
                            ))}
                        </div>
                    </section>

                    <section className="bg-slate-900/60 border border-slate-800 rounded-2xl p-6 space-y-4">
                        <div className="flex flex-col md:flex-row md:items-end gap-4">
                            <div className="flex-1">
                                <label htmlFor="query-input" className="block text-xs text-slate-400 uppercase tracking-wide mb-1">RAG Query</label>
                                <input
                                    id="query-input"
                                    data-testid="query-input"
                                    type="text"
                                    value={query}
                                    onChange={(e) => setQuery(e.target.value)}
                                    placeholder="ค้นหาเนื้อหา ตัวอย่าง: Transformer"
                                    className="w-full px-3 py-2 rounded-lg bg-slate-950 border border-slate-800 focus:border-violet-500 focus:ring-2 focus:ring-violet-500/40"
                                />
                            </div>
                            <button
                                type="button"
                                data-testid="query-submit"
                                onClick={handleQuery}
                                disabled={queryLoading}
                                className="px-6 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-700 font-semibold"
                            >
                                {queryLoading ? 'Searching…' : 'Run query'}
                            </button>
                        </div>
                        {queryResults.length > 0 ? (
                            <div className="space-y-3" data-testid="query-results">
                                {queryResults.map(result => (
                                    <div key={result.id} className="p-4 rounded-xl border border-slate-800 bg-slate-950/60">
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <div className="text-base font-semibold text-white">{result.title}</div>
                                                <p className="text-xs text-slate-400">{result.template_name}</p>
                                            </div>
                                            <span className="text-xs text-slate-500">{formatDateTime(result.created_at)}</span>
                                        </div>
                                        {result.content_preview && (
                                            <p className="text-sm text-slate-300 mt-2 line-clamp-3">{result.content_preview}</p>
                                        )}
                                        {Array.isArray(result.tags) && result.tags.length > 0 && (
                                            <div className="flex flex-wrap gap-2 mt-3">
                                                {result.tags.map(tag => (
                                                    <span key={tag} className="px-2 py-1 bg-slate-800 rounded-full text-xs text-slate-300">{tag}</span>
                                                ))}
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <p className="text-sm text-slate-500">ยังไม่มีผลการค้นหา</p>
                        )}
                    </section>

                    <section className="space-y-4">
                        <div className="flex items-center justify-between">
                            <h2 className="text-xl font-semibold">Knowledge items</h2>
                            <span className="text-sm text-slate-400">รวมข้อมูลที่นำเข้าทั้งหมด</span>
                        </div>
                        <div className="overflow-x-auto border border-slate-800 rounded-2xl">
                            <table className="min-w-full divide-y divide-slate-800">
                                <thead className="bg-slate-900/80">
                                    <tr className="text-left text-xs uppercase text-slate-400 tracking-wide">
                                        <th className="px-4 py-3">Title</th>
                                        <th className="px-4 py-3">Source</th>
                                        <th className="px-4 py-3">Template</th>
                                        <th className="px-4 py-3">Tags</th>
                                        <th className="px-4 py-3">Created</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-800">
                                    {loading ? (
                                        <tr>
                                            <td colSpan="5" className="px-4 py-6 text-center text-slate-400">กำลังโหลดข้อมูล...</td>
                                        </tr>
                                    ) : items.length === 0 ? (
                                        <tr>
                                            <td colSpan="5" className="px-4 py-6 text-center text-slate-500">ยังไม่มีข้อมูล</td>
                                        </tr>
                                    ) : (
                                        items.map(item => (
                                            <tr key={item.id} data-testid="knowledge-table-row" className="hover:bg-slate-900/60">
                                                <td className="px-4 py-3">
                                                    <div className="text-sm font-semibold text-white">{item.title}</div>
                                                    {item.url && (
                                                        <a href={item.url} target="_blank" rel="noopener noreferrer" className="text-xs text-violet-300 hover:text-violet-200">
                                                            เปิดลิงก์
                                                        </a>
                                                    )}
                                                </td>
                                                <td className="px-4 py-3 text-sm capitalize text-slate-300">{item.source_type}</td>
                                                <td className="px-4 py-3 text-sm text-slate-300">{item.template_name}</td>
                                                <td className="px-4 py-3 text-sm text-slate-300">
                                                    {Array.isArray(item.tags) && item.tags.length > 0 ? (
                                                        <div className="flex flex-wrap gap-1">
                                                            {item.tags.map(tag => (
                                                                <span key={tag} className="px-2 py-0.5 bg-slate-800 rounded-full text-xs">{tag}</span>
                                                            ))}
                                                        </div>
                                                    ) : (
                                                        <span className="text-slate-500">-</span>
                                                    )}
                                                </td>
                                                <td className="px-4 py-3 text-sm text-slate-400">{formatDateTime(item.created_at)}</td>
                                            </tr>
                                        ))
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('knowledge-platform-root'));
        root.render(<KnowledgePlatform />);
    </script>
</body>
</html>
